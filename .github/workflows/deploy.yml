name: Deploy Blog
run-name: Deploying Blog to ${{ (github.event_name == 'workflow_dispatch' && inputs.environment) || 'UAT' }} by ${{ github.actor }}

on:
  push:
    branches: [hexo-source]
  workflow_dispatch:
    inputs:
      environment:
        description: "éƒ¨ç½²ç¯å¢ƒ"
        required: true
        type: choice
        default: "uat"
        options:
          - uat
          - prod
      deploy_to_master:
        description: "éƒ¨ç½²åˆ°Masteråˆ†æ”¯"
        required: false
        type: boolean
        default: true
      deploy_to_aliyun:
        description: "éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨"
        required: false
        type: boolean
        default: true

jobs:
  build-for-master:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || inputs.deploy_to_master }}

    steps:
      - name: Checkout hexo-source branch
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Set deployment environment
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "DEPLOY_ENV=${{ inputs.environment }}" >> $GITHUB_ENV
          else
            echo "DEPLOY_ENV=uat" >> $GITHUB_ENV
          fi
          echo "å½“å‰éƒ¨ç½²ç¯å¢ƒ: ${{ env.DEPLOY_ENV }} (Masteræ„å»º)"

      - name: Build Hexo blog for Master
        run: |
          echo "ä½¿ç”¨ _config_Master.yml æ„å»º..."
          cp ./script/_config_Master.yml _config.yml
          npm run build

      - name: Save build output for Master
        uses: actions/upload-artifact@v4
        with:
          name: hexo-output-master
          path: ./public
          retention-days: 1

  build-for-aliyun:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || inputs.deploy_to_aliyun }}

    steps:
      - name: Checkout hexo-source branch
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Set deployment environment
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "DEPLOY_ENV=${{ inputs.environment }}" >> $GITHUB_ENV
          else
            echo "DEPLOY_ENV=uat" >> $GITHUB_ENV
          fi
          echo "å½“å‰éƒ¨ç½²ç¯å¢ƒ: ${{ env.DEPLOY_ENV }} (é˜¿é‡Œäº‘æ„å»º)"

      - name: Build Hexo blog for Aliyun
        run: |
          echo "ä½¿ç”¨ _config_Web.yml æ„å»º..."
          cp ./script/_config_Web.yml _config.yml
          npm run build

      - name: Save build output for Aliyun
        uses: actions/upload-artifact@v4
        with:
          name: hexo-output-aliyun
          path: ./public
          retention-days: 1

  deploy-to-master:
    runs-on: ubuntu-latest
    needs: build-for-master
    if: ${{ github.event_name == 'push' || inputs.deploy_to_master }}

    steps:
      - name: Set deployment environment
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "DEPLOY_ENV=${{ inputs.environment }}" >> $GITHUB_ENV
          else
            echo "DEPLOY_ENV=uat" >> $GITHUB_ENV
          fi

      - name: Download build output
        uses: actions/download-artifact@v4
        with:
          name: hexo-output-master
          path: ./public

      - name: Setup Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "gengjian1203@foxmail.com"

      - name: Deploy to master branch
        run: |
          cd ./public
          git init
          git add .

          if [ "${{ env.DEPLOY_ENV }}" == "prod" ]; then
            git commit -m "ã€ç”Ÿäº§ç¯å¢ƒã€‘é€šè¿‡GitHub Actionséƒ¨ç½² - ${{ github.sha }}"
          else
            git commit -m "ã€æµ‹è¯•ç¯å¢ƒã€‘é€šè¿‡GitHub Actionséƒ¨ç½² - ${{ github.sha }}"
          fi

          git push -f https://${{ secrets.GITHUB_TOKEN }}@github.com/gengjian1203/gengjian1203.github.io.git HEAD:master
          echo "ğŸ‰ æˆåŠŸéƒ¨ç½²åˆ°masteråˆ†æ”¯ (ç¯å¢ƒ: ${{ env.DEPLOY_ENV }})"

  deploy-to-aliyun:
    runs-on: ubuntu-latest
    needs: build-for-aliyun
    if: ${{ github.event_name == 'push' || inputs.deploy_to_aliyun }}

    steps:
      - name: Set deployment environment
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "DEPLOY_ENV=${{ inputs.environment }}" >> $GITHUB_ENV
          else
            echo "DEPLOY_ENV=uat" >> $GITHUB_ENV
          fi

      - name: Checkout hexo-source branch
        uses: actions/checkout@v4

      - name: Download build output
        uses: actions/download-artifact@v4
        with:
          name: hexo-output-aliyun
          path: ./gengjian1203

      - name: Prepare for Aliyun deployment
        run: |
          # åˆ›å»ºå‹ç¼©åŒ…
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          FOLDER_NAME="gengjian1203"

          # æ ¹æ®ç¯å¢ƒè®¾ç½®ä¸åŒçš„æ–‡ä»¶å¤¹åç§°
          if [ "${{ env.DEPLOY_ENV }}" == "prod" ]; then
            FOLDER_NAME="gengjian1203"
          else
            FOLDER_NAME="uat/gengjian1203"
          fi

          TAR_NAME="${FOLDER_NAME}_${TIMESTAMP}.tar.gz"
          tar -zcvf $TAR_NAME -C ./gengjian1203 .
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV
          echo "FOLDER_NAME=$FOLDER_NAME" >> $GITHUB_ENV
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

      - name: Upload to Aliyun
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          source: ${{ env.TAR_NAME }}
          target: ${{ secrets.SERVER_BACKUP_PATH }}

      - name: Extract on Aliyun
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            rm -rf ${{ secrets.SERVER_HTML }}/${{ env.FOLDER_NAME }}
            mkdir -p ${{ secrets.SERVER_HTML }}/${{ env.FOLDER_NAME }}
            tar -xvf ${{ secrets.SERVER_BACKUP_PATH }}/${{ env.TAR_NAME }} -C ${{ secrets.SERVER_HTML }}/${{ env.FOLDER_NAME }}
            echo "ğŸ‰ æˆåŠŸéƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨ (ç¯å¢ƒ: ${{ env.DEPLOY_ENV }})"
